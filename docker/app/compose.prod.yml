services:
  backend-api:
    build:
      context: ../..
      dockerfile: backend-api/Dockerfile
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:postgresql://stock-platform-postgres:5432/stock_platform}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-stock}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-change_me}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-}
      DATA_COLLECTOR_ENABLED: ${DATA_COLLECTOR_ENABLED:-true}
      DATA_COLLECTOR_WORKING_DIR: ${DATA_COLLECTOR_WORKING_DIR:-/opt/data-collector}
      DATA_COLLECTOR_PYTHON_PATH: ${DATA_COLLECTOR_PYTHON_PATH:-/opt/data-collector/venv/bin/python}
      DATA_COLLECTOR_PRICE_PROVIDER: ${DATA_COLLECTOR_PRICE_PROVIDER:-stooq}
      DATA_COLLECTOR_METADATA_PROVIDER: ${DATA_COLLECTOR_METADATA_PROVIDER:-auto}
      EODHD_API_TOKEN: ${EODHD_API_TOKEN:-}
      EODHD_USE_FOR_SPX: ${EODHD_USE_FOR_SPX:-false}
      SECURITY_JWT_SECRET: ${SECURITY_JWT_SECRET:-}
      INIT_ADMIN_USERNAME: ${INIT_ADMIN_USERNAME:-}
      INIT_ADMIN_PASSWORD: ${INIT_ADMIN_PASSWORD:-}
      INIT_ADMIN_FORCE_RESET_PASSWORD: ${INIT_ADMIN_FORCE_RESET_PASSWORD:-false}
      SECURITY_DEV_AUTH_ENABLED: ${SECURITY_DEV_AUTH_ENABLED:-false}
      SECURITY_DEV_AUTH_USERNAME: ${SECURITY_DEV_AUTH_USERNAME:-}
      SECURITY_DEV_AUTH_ROLES: ${SECURITY_DEV_AUTH_ROLES:-admin}
      SECURITY_DEV_AUTH_AUTO_CREATE_USER: ${SECURITY_DEV_AUTH_AUTO_CREATE_USER:-true}
      SECURITY_DEV_AUTH_ONLY_IF_MISSING_AUTHORIZATION: ${SECURITY_DEV_AUTH_ONLY_IF_MISSING_AUTHORIZATION:-true}
      TZ: ${TZ:-Asia/Shanghai}
    networks:
      - stock_platform_net

  frontend-web:
    build:
      context: ../..
      dockerfile: frontend-web/Dockerfile
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-8089}:80"
    depends_on:
      - backend-api
    networks:
      - stock_platform_net

networks:
  stock_platform_net:
    external: true
    name: stock-platform-net
